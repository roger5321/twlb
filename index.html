<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台彩全方位即時看板 (V7 強力解析版)</title>
    <style>
        /* --- CSS 樣式區 (維持一致) --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f4f4f4; padding-bottom: 50px; }
        
        header {
            background-color: #FFCC00;
            border-bottom: 5px solid #009933;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        h1 { font-size: 1.6rem; color: #333; font-weight: 800; letter-spacing: 1px; }
        .status-bar { font-size: 0.9rem; color: #444; margin-top: 8px; font-weight: 500; }
        .refresh-count { color: #cc0000; font-weight: bold; font-size: 1.1em; }
        .proxy-info { font-size: 0.75rem; color: #666; margin-top: 4px; }

        .container {
            max-width: 1200px;
            margin: 25px auto;
            padding: 0 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .lottery-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            border-top: 5px solid #FFCC00;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s;
        }
        
        .lottery-card:hover { transform: translateY(-5px); }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .game-title-group { display: flex; flex-direction: column; }
        .game-name { font-size: 1.4rem; font-weight: bold; color: #009933; margin-bottom: 4px; }
        .draw-date { font-size: 0.85rem; color: #888; }
        
        .draw-term { 
            background: #eee; 
            color: #555; 
            padding: 4px 10px; 
            border-radius: 20px; 
            font-size: 0.85rem; 
            font-weight: bold; 
            white-space: nowrap;
        }

        .numbers-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin-bottom: 20px; 
            flex-grow: 1;
            align-items: center;
        }
        
        .ball {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.15rem;
            box-shadow: inset -2px -2px 6px rgba(0,0,0,0.2), 2px 2px 5px rgba(0,0,0,0.1);
        }

        .ball.normal {
            background: radial-gradient(circle at 35% 35%, #fffacd, #ffd700);
            border: 1px solid #e6b800;
            color: #222;
        }

        .ball.special {
            background: radial-gradient(circle at 35% 35%, #ff9999, #cc0000);
            border: 1px solid #b30000;
            color: #fff;
            position: relative;
            margin-left: 5px;
        }
        
        .ball.special::before {
            content: '特';
            position: absolute;
            top: -8px;
            font-size: 0.6rem;
            color: #cc0000;
            font-weight: bold;
        }

        .btn-history {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #009933;
            color: white;
            text-align: center;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            transition: background 0.3s;
            margin-top: auto; 
        }
        
        .btn-history:hover { background-color: #007a29; }

        .loading, .error-msg { text-align: center; padding: 40px; color: #666; grid-column: 1 / -1; }
        .error-msg { color: #d9534f; background: #fff; border-radius: 8px; border: 1px solid #ffcccc;}
        .retry-btn { margin-top: 15px; padding: 8px 25px; background: #333; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

    <header>
        <h1>台彩最新獎號看板</h1>
        <div class="status-bar">
            狀態: <span id="last-update">初始化中...</span> | 
            <span id="countdown" class="refresh-count">30</span> 秒後刷新
        </div>
        <div class="proxy-info" id="proxy-status">使用線路：自動偵測中...</div>
    </header>

    <div id="app" class="container">
        <div class="loading">
            <h2>正在同步 Lotto-8 資料庫...</h2>
            <p>正在進行智慧型數據解析</p>
        </div>
    </div>

    <script>
        const REFRESH_INTERVAL = 30; 
        const TARGET_URL = 'https://www.lotto-8.com/listlto.asp'; 
        
        // 雙重線路備援
        const PROXIES = [
            'https://corsproxy.io/?',              
            'https://api.allorigins.win/raw?url='  
        ];
        let currentProxyIndex = 0;

        let timer = null;
        let countdownVal = REFRESH_INTERVAL;
        let countdownTimer = null;

        const RULES = {
            '威力彩': { count: 6, special: 1 },
            '大樂透': { count: 6, special: 1 },
            '今彩539': { count: 5, special: 0 },
            '雙贏彩': { count: 12, special: 0 },
            '3星彩': { count: 3, special: 0 },
            '4星彩': { count: 4, special: 0 },
            '38樂合彩': { count: 6, special: 0 },
            '49樂合彩': { count: 6, special: 0 },
            '39樂合彩': { count: 5, special: 0 }
        };

        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            startTimers();
        });

        function startTimers() {
            if(countdownTimer) clearInterval(countdownTimer);
            countdownTimer = setInterval(() => {
                countdownVal--;
                document.getElementById('countdown').innerText = countdownVal;
                if (countdownVal <= 0) countdownVal = REFRESH_INTERVAL;
            }, 1000);

            if(timer) clearInterval(timer);
            timer = setInterval(fetchData, REFRESH_INTERVAL * 1000);
        }

        async function fetchData() {
            const container = document.getElementById('app');
            const statusEl = document.getElementById('proxy-status');
            
            try {
                countdownVal = REFRESH_INTERVAL;
                document.getElementById('countdown').innerText = countdownVal;

                const proxy = PROXIES[currentProxyIndex];
                statusEl.innerText = `使用線路: ${currentProxyIndex === 0 ? '極速線路 (CorsProxy)' : '備援線路 (AllOrigins)'}`;

                const fetchUrl = `${proxy}${encodeURIComponent(TARGET_URL)}?t=${Date.now()}`;
                
                const response = await fetch(fetchUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const buffer = await response.arrayBuffer();
                let decoder = new TextDecoder("utf-8");
                let text = decoder.decode(buffer);
                
                // 自動偵測 Big5
                if (!text.includes('彩') && !text.includes('期')) {
                    decoder = new TextDecoder("big5");
                    text = decoder.decode(buffer);
                }

                const results = parseTextContent(text);
                
                if (Object.keys(results).length === 0) {
                    throw new Error('解析不到任何資料');
                }

                renderCards(results);
                
                const now = new Date();
                document.getElementById('last-update').innerText = now.toLocaleTimeString();

            } catch (error) {
                console.error('Fetch error:', error);
                
                if (currentProxyIndex < PROXIES.length - 1) {
                    currentProxyIndex++;
                    fetchData(); 
                    return;
                }

                if (!container.querySelector('.lottery-card')) {
                    container.innerHTML = `
                        <div class="error-msg">
                            <h3>讀取失敗 (${error.message})</h3>
                            <p>無法連線，請稍後再試。</p>
                            <button class="retry-btn" onclick="location.reload()">重新整理</button>
                        </div>
                    `;
                }
                currentProxyIndex = 0;
            }
        }

        // --- V7 全新解析引擎 ---
        function parseTextContent(htmlText) {
            // 1. 預處理：將所有 HTML tag 轉為空白，保留文字
            // 但保留重要的區隔符號，避免數字黏在一起
            let cleanText = htmlText
                .replace(/<(br|tr|div|p|td)[^>]*>/gi, ' | ') // 將區塊標籤變成 | 符號
                .replace(/<[^>]*>/g, ' ') 
                .replace(/&nbsp;/g, ' ')
                .replace(/\s+/g, ' '); 

            const results = {};
            const games = Object.keys(RULES);

            games.forEach(game => {
                const index = cleanText.indexOf(game);
                if (index !== -1) {
                    // 抓取遊戲名稱後方 300 字的範圍
                    // 注意：Lotto-8 有時候日期在前面，有時候在後面，所以我們也抓前面一點點
                    const startIdx = Math.max(0, index - 50);
                    const context = cleanText.substring(startIdx, index + 350);
                    
                    // --- 智慧型數據提取 ---
                    
                    // 1. 抓日期 (格式 YYYY/MM/DD)
                    const dateMatch = context.match(/(\d{3,4}[\/-]\d{1,2}[\/-]\d{1,2})/);
                    const date = dateMatch ? dateMatch[1] : '未知日期';

                    // 2. 將字串中的所有「非數字」都變成空白，方便切割
                    // 但要小心，不要把日期裡的數字混進去，所以先把日期字串消掉
                    let tempText = context.replace(date, ''); 
                    
                    // 找出所有獨立的數字串
                    // 正則解釋：找出單獨存在的數字
                    let allNumbers = tempText.match(/\b\d+\b/g);

                    if (allNumbers) {
                        let term = '???';
                        let ballCandidates = [];

                        // 3. 分類數字：期數 vs 號碼球
                        allNumbers.forEach(numStr => {
                            const num = parseInt(numStr, 10);
                            
                            // 邏輯：
                            // 期數通常大於 100000 (如 112000055)
                            // 號碼球通常在 1~99 之間
                            
                            if (num > 100000) {
                                // 這一定是期數
                                // 如果有多個大數字，取第一個或最大的 (通常只有一個)
                                term = numStr; 
                            } else if (num >= 0 && num <= 99) {
                                // 可能是號碼球，或是日期的殘留 (如月/日)
                                // 為了保險，我們先收集起來
                                ballCandidates.push(num);
                            }
                        });

                        // 4. 根據遊戲規則，從候選球中取出正確數量的獎號
                        const rule = RULES[game];
                        const totalNeeded = rule.count + rule.special;
                        
                        // Lotto-8 的順序通常是: 期數 -> (日期) -> 號碼
                        // 或者是: 名稱 -> 期數 -> ...
                        // 我們假設 ballCandidates 裡面包含了一組連續的獎號
                        // 策略：取陣列中「連續出現」的最後 N 個數字 (因為日期/月份的雜訊通常在前面)
                        // 或者是：取前 N 個？
                        
                        // Lotto-8 結構：名稱 | 期數 | 日期 | 01 | 02 | 03 ...
                        // 所以號碼通常在最後面。
                        // 如果期數沒抓到 (例如三星彩期數較短 112032)，則嘗試在 >= 6 位數尋找
                        // 如果還是沒抓到，就嘗試找 > 100 的數字
                        if (term === '???') {
                             const potentialTerm = allNumbers.find(n => n.length >= 6);
                             if (potentialTerm) term = potentialTerm;
                        }

                        if (ballCandidates.length >= totalNeeded) {
                            // 取最後 totalNeeded 個數字 (避開前面的月份/日期雜訊)
                            // 例如: 12 (月) 25 (日) 01 02 03 04 05 ...
                            // 我們要後面的
                            let finalBalls = ballCandidates.slice(ballCandidates.length - totalNeeded);
                            
                            // 特殊處理：三星彩/四星彩的數字可能重複，且可能包含0
                            // Lotto-8 上面的三星彩號碼是分開的嗎？是的
                            
                            let finalNormal = [];
                            let finalSpecial = [];

                            if (rule.special > 0) {
                                finalSpecial = [finalBalls.pop()];
                                finalNormal = finalBalls;
                            } else {
                                finalNormal = finalBalls;
                            }

                            results[game] = {
                                term: term,
                                date: date,
                                normal: finalNormal,
                                special: finalSpecial
                            };
                        }
                    }
                }
            });
            return results;
        }

        function renderCards(data) {
            const container = document.getElementById('app');
            let html = '';
            
            const order = ['威力彩', '大樂透', '今彩539', '雙贏彩', '3星彩', '4星彩', '38樂合彩', '49樂合彩', '39樂合彩'];
            
            order.forEach(name => {
                if (data[name]) {
                    html += createCardHtml(name, data[name]);
                }
            });

            if(html === '') throw new Error('解析數據為空');
            container.innerHTML = html;
        }

        function createCardHtml(name, item) {
            const historyLink = 'https://www.taiwanlottery.com.tw/lotto/index.aspx';
            
            let ballsHtml = '';
            item.normal.forEach(n => {
                const s = n.toString().padStart(2, '0');
                ballsHtml += `<div class="ball normal">${s}</div>`;
            });
            item.special.forEach(n => {
                const s = n.toString().padStart(2, '0');
                ballsHtml += `<div class="ball special">${s}</div>`;
            });

            return `
                <div class="lottery-card">
                    <div class="card-header">
                        <div class="game-title-group">
                            <div class="game-name">${name}</div>
                            <div class="draw-date">${item.date}</div>
                        </div>
                        <div class="draw-term">第 ${item.term} 期</div>
                    </div>
                    <div class="numbers-container">
                        ${ballsHtml}
                    </div>
                    <a href="${historyLink}" target="_blank" class="btn-history">查詢歷史獎號</a>
                </div>
            `;
        }
    </script>
</body>
</html>